# Simple LUKS2-on-LVM layout (note: d-i's "encrypted LVM" partioning
# method is LVM-on-LUKS2 and can be found in d/t/cryptroot-lvm)

sfdisk --append /dev/vda <<-EOF
	unit: sectors

	start=$((64*1024*2)), size=$((128*1024*2)), type=${GUID_TYPE_Linux_FS}
	start=$(((64+128)*1024*2)), type=${GUID_TYPE_LVM}
EOF

lvm pvcreate /dev/vda3
lvm vgcreate "testvg" /dev/vda3
lvm lvcreate -Zn --size 64m --name "cryptswap" "testvg"
lvm lvcreate -Zn -l100%FREE --name "cryptroot" "testvg"
lvm vgchange -ay "testvg"
lvm vgmknodes

echo -n "root_crypt" >/rootfs.key
cryptsetup luksFormat --batch-mode \
    --key-file=/rootfs.key \
    --type=luks2 \
    --pbkdf=argon2id \
    --pbkdf-force-iterations=4 \
    --pbkdf-memory=32 \
    -- /dev/testvg/cryptroot
cryptsetup luksOpen --key-file=/rootfs.key --allow-discards \
    -- /dev/testvg/cryptroot "root_crypt"

echo -n "swap_crypt" >/swap.key
cryptsetup luksFormat --batch-mode \
    --key-file=/swap.key \
    --type=luks2 \
    --pbkdf=argon2id \
    --pbkdf-force-iterations=4 \
    --pbkdf-memory=32 \
    -- /dev/testvg/cryptswap
cryptsetup luksOpen --key-file=/swap.key --allow-discards \
    -- /dev/testvg/cryptswap "swap_crypt"

mkdir /target
mke2fs -Ft ext4 /dev/mapper/root_crypt
mount -t ext4 /dev/mapper/root_crypt /target

mkdir /target/boot
mke2fs -Ft ext2 -m0 /dev/vda2
mount -t ext2 /dev/vda2 /target/boot

mkswap /dev/mapper/swap_crypt
swapon /dev/mapper/swap_crypt

# vim: set filetype=sh :
